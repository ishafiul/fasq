# QueryClient

The `QueryClient` is the core controller of Fasq. It manages the query cache, deduplication, and garbage collection.

## Initialization

It is best to provide the `QueryClient` at the top of your widget tree using `QueryClientProvider`, but it can also be used as a singleton if desired.

```dart
import 'package:fasq/fasq.dart';

void main() {
  final client = QueryClient();

  runApp(
    QueryClientProvider(
      client: client,
      child: MyApp(),
    ),
  );
}
```

## Global Configuration

You can define default behaviors for all queries in your app.

```dart
final client = QueryClient(
  config: const CacheConfig(
    defaultStaleTime: Duration(minutes: 5), // Data is fresh for 5 mins
    defaultCacheTime: Duration(minutes: 30), // Inactive data kept for 30 mins
  ),
);
```

## Cache Management

### Invalidation

Mark data as stale so it gets refetched the next time it's used.

```dart
// Invalidate a single query
client.invalidateQuery('todos'.toQueryKey());

// Invalidate with refetch (default behavior for active queries)
client.invalidateQuery('todos'.toQueryKey(), refetchType: InvalidateType.active);
```

### Pre-fetching

Load data before the user navigates there to provide an instant experience.

```dart
await client.prefetchQuery(
  'todos'.toQueryKey(),
  () => fetchTodos(),
);
```

### Manual Updates

You can update the cache directly without hitting the network (useful for optimistic updates).

```dart
// Update data
client.setQueryData<List<Todo>>(
  'todos'.toQueryKey(),
  (oldData) => [...?oldData, newTodo],
);

// Read data
final todos = client.getQueryData<List<Todo>>('todos'.toQueryKey());
```

## Observers

`QueryClient` supports observers that can monitor all query and mutation lifecycle events. This is useful for logging, analytics, error tracking, and more.

### Adding Observers

```dart
final client = QueryClient();

// Add built-in logger
client.addObserver(FasqLogger());

// Add custom observer
client.addObserver(MyCustomObserver());
```

### Built-in Logger

Fasq includes `FasqLogger` for development debugging:

```dart
client.addObserver(FasqLogger(
  enabled: true,
  showData: false, // Privacy-first: don't log data by default
  truncateLength: 100,
));
```

For complete logging documentation, see [Logging](/docs/core/logging).

### Custom Observers

Create custom observers by implementing `QueryClientObserver`:

```dart
class AnalyticsObserver implements QueryClientObserver {
  @override
  void onQuerySuccess(QuerySnapshot snapshot, QueryMeta? meta, BuildContext? context) {
    analytics.track('query_success', {
      'key': snapshot.queryKey.toString(),
      'duration': calculateDuration(snapshot),
    });
  }

  // Implement other observer methods...
}
```

### Observer Management

```dart
// Add observer
client.addObserver(myObserver);

// Remove observer
client.removeObserver(myObserver);

// Clear all observers
client.clearObservers();
```

## API Reference

| Method            | Description                                                    |
| ----------------- | -------------------------------------------------------------- |
| `fetchQuery`      | Fetches a query and returns the result (throws on error).      |
| `prefetchQuery`   | Fetches a query and stores it in cache (no return, safe).      |
| `getQueryData`    | Synchronously returns the current data in cache.               |
| `setQueryData`    | Synchronously updates the data in cache.                       |
| `invalidateQuery` | Marks queries as stale and potentially refetches them.         |
| `cancelQuery`     | Cancels any outgoing fetches for a query.                      |
| `resetQuery`      | Resets a query to its initial state.                           |
| `addObserver`     | Adds a `QueryClientObserver` to monitor query/mutation events. |
| `removeObserver`  | Removes an observer from the client.                           |
| `clearObservers`  | Removes all observers from the client.                         |
