# QueryCubit

The `QueryCubit` is an abstract base class that wraps a Fasq query, emitting `QueryState` changes. Extend `QueryCubit` to create your own query cubits with type-safe, structured state management.

## Basic Usage

Extend `QueryCubit` and implement the required getters:

```dart
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:fasq_bloc/fasq_bloc.dart';

class UsersQueryCubit extends QueryCubit<List<User>> {
  @override
  String get key => 'users';

  @override
  Future<List<User>> Function() get queryFn => () => api.fetchUsers();
}

class UsersScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Users')),
      body: BlocProvider(
        create: (context) => UsersQueryCubit(),
        child: BlocBuilder<UsersQueryCubit, QueryState<List<User>>>(
          builder: (context, state) {
            if (state.isLoading) {
              return Center(child: CircularProgressIndicator());
            }

            if (state.hasError) {
              return Center(child: Text('Error: ${state.error}'));
            }

            if (state.hasData) {
              return ListView.builder(
                itemCount: state.data!.length,
                itemBuilder: (context, index) {
                  final user = state.data![index];
                  return ListTile(title: Text(user.name));
                },
              );
            }

            return Center(child: Text('No users found.'));
          },
        ),
      ),
    );
  }
}
```

## Cubit Configuration

Configure query behavior by overriding the `options` getter:

```dart
class UsersQueryCubit extends QueryCubit<List<User>> {
  @override
  String get key => 'users';

  @override
  Future<List<User>> Function() get queryFn => () => api.fetchUsers();

  @override
  QueryOptions? get options => QueryOptions(
    staleTime: Duration(minutes: 5),
    cacheTime: Duration(minutes: 10),
    enabled: true,
    onSuccess: () {
      print('Users fetched successfully');
    },
    onError: (error) {
      print('Error fetching users: $error');
    },
  );
}
```

## Parameterized Queries

Use constructor parameters or fields for dynamic query keys:

```dart
class UserProfileQueryCubit extends QueryCubit<User> {
  final String userId;

  UserProfileQueryCubit(this.userId);

  @override
  String get key => 'user:$userId';

  @override
  Future<User> Function() get queryFn => () => api.fetchUser(userId);
}

class UserProfileScreen extends StatelessWidget {
  final String userId;
  
  const UserProfileScreen({required this.userId});
  
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('User Profile')),
      body: BlocProvider(
        create: (context) => UserProfileQueryCubit(userId),
        child: BlocBuilder<UserProfileQueryCubit, QueryState<User>>(
          builder: (context, state) {
            if (state.isLoading) return CircularProgressIndicator();
            if (state.hasError) return Text('Error: ${state.error}');
            if (state.hasData) return UserDetails(user: state.data!);
            return SizedBox();
          },
        ),
      ),
    );
  }
}
```

## Conditional Queries

Disable queries based on conditions using the `enabled` option:

```dart
class UserProfileQueryCubit extends QueryCubit<User?> {
  final String? userId;

  UserProfileQueryCubit(this.userId);

  @override
  String get key => 'user:$userId';

  @override
  Future<User?> Function() get queryFn => () => api.fetchUser(userId!);

  @override
  QueryOptions? get options => QueryOptions(
    enabled: userId != null,
  );
}

class UserProfileScreen extends StatelessWidget {
  final String? userId;
  
  const UserProfileScreen({this.userId});
  
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('User Profile')),
      body: BlocProvider(
        create: (context) => UserProfileQueryCubit(userId),
        child: BlocBuilder<UserProfileQueryCubit, QueryState<User?>>(
          builder: (context, state) {
            if (userId == null) {
              return Center(child: Text('Please select a user'));
            }
            
            if (state.isLoading) return CircularProgressIndicator();
            if (state.hasError) return Text('Error: ${state.error}');
            if (state.hasData) return UserDetails(user: state.data!);
            return SizedBox();
          },
        ),
      ),
    );
  }
}
```

## Dependent Queries

Create dependent queries by checking other cubit states:

```dart
class UserPostsQueryCubit extends QueryCubit<List<Post>> {
  final String userId;

  UserPostsQueryCubit(this.userId);

  @override
  String get key => 'posts:user:$userId';

  @override
  Future<List<Post>> Function() get queryFn => () => api.fetchUserPosts(userId);

  @override
  QueryOptions? get options => QueryOptions(
    enabled: false,
  );
}

class UserPostsScreen extends StatelessWidget {
  final String userId;
  
  const UserPostsScreen({required this.userId});
  
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('User Posts')),
      body: MultiBlocProvider(
        providers: [
          BlocProvider(create: (context) => UserProfileQueryCubit(userId)),
          BlocProvider(create: (context) => UserPostsQueryCubit(userId)),
        ],
        child: BlocBuilder<UserProfileQueryCubit, QueryState<User>>(
          builder: (context, userState) {
            if (userState.isLoading) {
              return Center(child: CircularProgressIndicator());
            }
            
            if (!userState.hasData) {
              return Center(child: Text('User not found'));
            }

            final postsCubit = context.read<UserPostsQueryCubit>();
            if (userState.hasData && postsCubit.state.isIdle) {
              postsCubit.refetch();
            }
            
            return BlocBuilder<UserPostsQueryCubit, QueryState<List<Post>>>(
              builder: (context, postsState) {
                if (postsState.isLoading) {
                  return Center(child: Text('Loading posts...'));
                }
                
                if (postsState.hasData) {
                  return PostsList(posts: postsState.data!);
                }
                
                return SizedBox();
              },
            );
          },
        ),
      ),
    );
  }
}
```

## Manual Refetching

Trigger manual refetches using the Cubit:

```dart
class RefreshButton extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return ElevatedButton(
      onPressed: () {
        context.read<UsersQueryCubit>().refetch();
      },
      child: Text('Refresh Users'),
    );
  }
}
```

## Cache Management

Access the QueryClient for advanced cache operations:

```dart
class CacheManager extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        ElevatedButton(
          onPressed: () {
            QueryClient().invalidateQuery('users');
          },
          child: Text('Invalidate Users'),
        ),
        ElevatedButton(
          onPressed: () {
            final cubit = context.read<UsersQueryCubit>();
            cubit.invalidate();
          },
          child: Text('Invalidate via Cubit'),
        ),
        ElevatedButton(
          onPressed: () {
            QueryClient().setQueryData('user:1', User(id: '1', name: 'John'));
          },
          child: Text('Set User Data'),
        ),
      ],
    );
  }
}
```

## Error Handling

Handle errors with retry functionality:

```dart
class UsersScreenWithErrorHandling extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Users')),
      body: BlocProvider(
        create: (context) => UsersQueryCubit(),
        child: BlocBuilder<UsersQueryCubit, QueryState<List<User>>>(
          builder: (context, state) {
            if (state.hasError) {
              return Center(
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Text('Error: ${state.error}'),
                    ElevatedButton(
                      onPressed: () {
                        context.read<UsersQueryCubit>().refetch();
                      },
                      child: Text('Retry'),
                    ),
                  ],
                ),
              );
            }
            
            if (state.isLoading) return CircularProgressIndicator();
            if (state.hasData) return UserList(users: state.data!);
            return SizedBox();
          },
        ),
      ),
    );
  }
}
```

## Background Refetching

Handle background refetching with `isFetching`:

```dart
class UsersScreenWithBackgroundRefresh extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Users')),
      body: BlocProvider(
        create: (context) => UsersQueryCubit(),
        child: BlocBuilder<UsersQueryCubit, QueryState<List<User>>>(
          builder: (context, state) {
            return Column(
              children: [
                if (state.isFetching && !state.isLoading)
                  LinearProgressIndicator(),
                Expanded(
                  child: state.when(
                    idle: () => Center(child: Text('Ready to load users')),
                    loading: () => Center(child: CircularProgressIndicator()),
                    error: (error, stack) => Center(child: Text('Error: $error')),
                    data: (users) => ListView.builder(
                      itemCount: users.length,
                      itemBuilder: (context, index) {
                        final user = users[index];
                        return ListTile(title: Text(user.name));
                      },
                    ),
                  ),
                ),
              ],
            );
          },
        ),
      ),
    );
  }
}
```

## Type Safety

Full generic type support ensures compile-time safety:

```dart
class UsersQueryCubit extends QueryCubit<List<User>> {
  @override
  String get key => 'users';

  @override
  Future<List<User>> Function() get queryFn => () => api.fetchUsers();
}

class TypeSafeUsersScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Users')),
      body: BlocProvider(
        create: (context) => UsersQueryCubit(),
        child: BlocBuilder<UsersQueryCubit, QueryState<List<User>>>(
          builder: (context, state) {
            if (state.hasData) {
              return ListView.builder(
                itemCount: state.data!.length,
                itemBuilder: (context, index) {
                  final user = state.data![index];
                  return ListTile(
                    title: Text(user.name),
                    subtitle: Text(user.email),
                  );
                },
              );
            }
            
            if (state.isLoading) return CircularProgressIndicator();
            if (state.hasError) return Text('Error: ${state.error}');
            return SizedBox();
          },
        ),
      ),
    );
  }
}
```

## Common Patterns

### Loading Skeleton

```dart
class UsersScreenWithSkeleton extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Users')),
      body: BlocProvider(
        create: (context) => UsersQueryCubit(),
        child: BlocBuilder<UsersQueryCubit, QueryState<List<User>>>(
          builder: (context, state) {
            if (state.isLoading) {
              return ListView.builder(
                itemCount: 5,
                itemBuilder: (context, index) => UserTileSkeleton(),
              );
            }
            
            if (state.hasData) {
              return ListView.builder(
                itemCount: state.data!.length,
                itemBuilder: (context, index) => UserTile(state.data![index]),
              );
            }
            
            return SizedBox();
          },
        ),
      ),
    );
  }
}
```

### Empty State

```dart
class UsersScreenWithEmptyState extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Users')),
      body: BlocProvider(
        create: (context) => UsersQueryCubit(),
        child: BlocBuilder<UsersQueryCubit, QueryState<List<User>>>(
          builder: (context, state) {
            if (state.isLoading) return CircularProgressIndicator();
            if (state.hasError) return Text('Error: ${state.error}');
            
            if (state.hasData) {
              if (state.data!.isEmpty) {
                return Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(Icons.people, size: 64, color: Colors.grey),
                      SizedBox(height: 16),
                      Text('No users found'),
                    ],
                  ),
                );
              }
              
              return ListView.builder(
                itemCount: state.data!.length,
                itemBuilder: (context, index) => UserTile(state.data![index]),
              );
            }
            
            return SizedBox();
          },
        ),
      ),
    );
  }
}
```

## Performance Tips

1. **Use descriptive query keys** - Makes debugging easier
2. **Include parameters in keys** - Enables proper caching
3. **Configure staleTime** - Reduces unnecessary refetches
4. **Handle loading states** - Provide good user experience
5. **Use error boundaries** - Graceful error handling

## Next Steps

- **[MutationCubit](/docs/bloc/mutation-cubit)** - Learn about mutations
- **[Bloc Patterns](/docs/bloc/bloc-patterns)** - Best practices
- **[Testing](/docs/bloc/testing)** - Testing strategies
- **[Examples](/docs/bloc/examples)** - Complete working examples
